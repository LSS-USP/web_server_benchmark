# Convert date string and concatenate it with time to make possible the
# conversion from string to POSIX date time
# @param date String date in the format 'YYYYMMDD'
# @param time Time in the formate 'HH:MM:SS'
# @return List of POSIX date
date_time_to_posix <- function(date, time)
{
  year <- substring(date, 1, 4)
  mounth <- substring(date, 5, 6)
  day <- substring(date, 7, 9)

  date <- paste(year, mounth, day, sep='-')
  string_to_convert <- paste(date, time)

  posix_date <- as.POSIXct(string_to_convert)

  return(posix_date)
}

# Read raw data generated by collectl.
# @param path_origin Path to raw data generated by collectl related with Memory
# @return Return a list, with the following informations: date, time, and data
load_memory_data <- function(path_origin)
{
    # Read all file
    raw_data <- read.table(path_origin)

    # Separate time information
    time_column <- raw_data[ ,1:2]
    time_column <- setNames(time_column, c('Date', 'Time'))
    posix_date <- date_time_to_posix(time_column$Date, time_column$Time)

      stop_in <- length(raw_data)
    memory_info <- raw_data[ ,3:stop_in]
    # The last field of cpu_cores keeps the information about date and time
    memory_info[length(memory_info) + 1] <- posix_date
    memory_label <- c('Used', 'Free', 'Slab', 'Mapped', 'Anon', 'AnonH',
                      'Inactive', 'Hits', 'PosixDate')
    memory_info <- setNames(memory_info, memory_label)
    return (memory_info)
}

# Plot CPU utilization, it has one line for each core.
# @param cpu_cores data structure generated by load_cpu_data
# @param destin Save image to
plot_used_memory <- function(memory_data, destin)
{
  # Setups
  png(destin, width=1024, height=768, res=100)
  par(xpd=TRUE, xaxs='i')
  total_elements <- length(memory_data)
  xlabel <- 'Time'
  ylabel <- 'Used (Gb)'
  kb_to_gb <- 1048576
  yrange <- c(0, max(memory_data$Used / kb_to_gb))

  # Note: The last element of memory_data it is date and time in POSIX format.
  plot(memory_data$PosixDate, memory_data$Used / kb_to_gb, type='l',
       ylim=yrange, col='red', cex.lab=1.5, lty=1, ylab=ylabel, xlab=xlabel,
       xaxt='n')

  # Prepare axis X
  # TODO
  total_samples <- length(memory_data$Used)
  display <- seq(memory_data$PosixDate[1],
                 memory_data$PosixDate[total_samples], length.out=10)

  axis(1, display, format(display, "%H:%M:%S"))
  dev.off()
  return (0)
}

# Read arguments
pathsArguments <- commandArgs(trailingOnly=TRUE)

# Test if there three argument. If not, return an error.
arguments <- length(pathsArguments)
if (arguments < 2 | arguments > 2)
{
  stop('You have to inform [origin] of file and [destin] of image')
} else if (length(pathsArguments) == 2)
{
  # default output file
  origin <- pathsArguments[1]
  destin <- pathsArguments[2]
}

memory <- load_memory_data(origin)
plot_used_memory(memory, destin)
