#!/usr/bin/env Rscript

# Load CSV file, and return data.frame structure
load_csv_file <- function(path_csv)
{
  data <- read.csv(file=path_csv, skip=1,
                   col.names=c('','Percentage','Time'))
  return(data)
}

# Plot csv file generated by ab. Basically, we have the binned data.
# @param graph_name name to save the graph.
# @param event Expect data.frame as a parameter with event data.
# @param worker Expect data.frame as a parameter with worker data.
# @param prefork Expect data.frame as a parameter with prefork data.
plot_mpm_csv_data <- function(graph_name, event, worker, prefork)
{
  margin <- c(5.1, 4.1, 2, 9.1)
  png(graph_name, width=1024, height=768)
  par(mar=margin, xpd=TRUE)

  limit_on_x <- max(prefork$Time, event$Time, worker$Time)
  range_x <- c(0, limit_on_x)
  xlabel <- 'Average Response Time (ms)'
  ylabel <- 'Percentage'

  # Event
  plot(event$Time, event$Percentage, type='l', col='blue',
        ylab=ylabel, xlab=xlabel, xlim=range_x, cex.lab=1.5, lwd=2)
  points(max(event$Time), max(event$Percentage) , pch=3, lwd=2)

  # Worker
  lines(worker$Time, worker$Percentage, type='l', col='green', lwd=2)
  points(max(worker$Time), max(worker$Percentage) , pch=3, lwd=2)

  # Prefork
  lines(prefork$Time, prefork$Percentage, type='l', col='red', lwd=2)
  points(max(prefork$Time), max(prefork$Percentage), pch=3)

  # Legend
  legend('topright', inset=c(-0.15,0), legend=c('Event','Prefork','worker'),
         lty=c(1,1,1), lwd=c(2.5,2.5,2.5), col=c('blue','red', 'green'))
  dev.off()
  return(0)
}

# Read arguments
pathsArguments <- commandArgs(trailingOnly=TRUE)

# Test if there three argument. If not, return an error.
if (length(pathsArguments) < 4)
{
  stop('You have to supply the path for each mpm strategy')
} else if (length(pathsArguments) == 4)
{
  # default output file
  graph_name <- pathsArguments[1]
  event_file <- pathsArguments[2]
  worker_file <- pathsArguments[3]
  prefork_file <- pathsArguments[4]
}

event <- load_csv_file(event_file)
worker <- load_csv_file(worker_file)
prefork <- load_csv_file(prefork_file)

plot_mpm_csv_data(graph_name, event, worker, prefork)
